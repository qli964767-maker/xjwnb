<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>采购需求生成</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/layui-src/dist/css/layui.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <style>
        body {
            background-color: #f5f5f5;
            padding: 15px;
        }
        .page-title {
            font-size: 18px;
            color: #333;
            padding: 10px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #e6e6e6;
        }
        .page-title i {
            color: #1E9FFF;
            margin-right: 8px;
        }
        .layui-card {
            margin-bottom: 20px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .layui-card-header {
            font-weight: 500;
            padding: 12px 15px;
        }
        .layui-form-label {
            width: 120px;
        }
        .layui-input-block {
            margin-left: 150px;
        }
        .required {
            color: #FF5722;
            margin-right: 3px;
        }
        .status-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #fff;
        }
        .status-draft {
            background-color: #9E9E9E;
        }
        .status-generated {
            background-color: #FF9800;
        }
        .status-confirmed {
            background-color: #4CAF50;
        }
        .status-canceled {
            background-color: #F44336;
        }
        .warning-tag {
            color: #FF5722;
            font-weight: bold;
        }
        .operate-btn {
            margin: 0 2px;
        }
        .search-bar {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .search-input {
            width: 250px;
        }
        .demand-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        .strategy-item {
            border: 1px solid #e6e6e6;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .strategy-item:hover {
            border-color: #1E9FFF;
        }
        .strategy-item.selected {
            border-color: #1E9FFF;
            background-color: #E8F4FD;
        }
        .demand-summary {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .summary-item {
            flex: 1;
            min-width: 150px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        .summary-value {
            font-size: 18px;
            font-weight: bold;
            color: #1E9FFF;
        }
        .summary-value.warning {
            color: #FF5722;
        }
        .demand-table {
            margin-top: 15px;
        }
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        .form-col {
            flex: 1;
        }
        .batch-operate {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <!-- 页面标题 -->
    <div class="page-title">
        <i class="fa fa-shopping-cart"></i>
        <span>采购需求生成</span>
    </div>

    <!-- 主内容区 -->
    <div class="layui-card">
        <div class="layui-card-body">
            <!-- 标签页 -->
            <div class="layui-tab" lay-allowClose="false" lay-filter="demandTab">
                <ul class="layui-tab-title">
                    <li class="layui-this" lay-id="generate">生成采购需求</li>
                    <li lay-id="pending">待确认需求</li>
                    <li lay-id="history">历史采购需求</li>
                    <li lay-id="settings">补货策略设置</li>
                </ul>
                <div class="layui-tab-content">
                    <!-- 生成采购需求 -->
                    <div class="layui-tab-item layui-show" id="generateTab">
                        <form class="layui-form" lay-filter="generateDemandForm">
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">
                                            <span class="required">*</span>需求单号
                                        </label>
                                        <div class="layui-input-block">
                                            <input type="text" name="demandNo" id="demandNo" readonly 
                                                class="layui-input layui-disabled" placeholder="系统自动生成">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">
                                            <span class="required">*</span>需求日期
                                        </label>
                                        <div class="layui-input-block">
                                            <input type="date" name="demandDate" lay-verify="required" 
                                                class="layui-input">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-col">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">
                                            <span class="required">*</span>目标仓库
                                        </label>
                                        <div class="layui-input-block">
                                            <select name="warehouseId" lay-verify="required" id="warehouseSelect">
                                                <option value="">请选择仓库</option>
                                                <option value="0">全部仓库</option>
                                                <option value="1">总仓</option>
                                                <option value="2">华东分仓</option>
                                                <option value="3">华南分仓</option>
                                                <option value="4">华北分仓</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">
                                            <span class="required">*</span>补货策略
                                        </label>
                                        <div class="layui-input-block">
                                            <select name="strategyId" lay-verify="required" id="strategySelect">
                                                <option value="">请选择补货策略</option>
                                                <option value="1">安全库存策略</option>
                                                <option value="2">销售预测策略</option>
                                                <option value="3">最小库存策略</option>
                                                <option value="4">自定义策略</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="layui-form-item">
                                <label class="layui-form-label">需求周期</label>
                                <div class="layui-input-block">
                                    <select name="demandCycle">
                                        <option value="week">下周</option>
                                        <option value="month" selected>下一个月</option>
                                        <option value="quarter">下一季度</option>
                                        <option value="custom">自定义</option>
                                    </select>
                                </div>
                            </div>

                            <div class="layui-form-item" id="customCycleContainer" style="display: none;">
                                <label class="layui-form-label">自定义周期</label>
                                <div class="layui-input-block" style="display: flex; gap: 10px;">
                                    <input type="date" name="cycleStart" class="layui-input">
                                    <span style="align-self: center;">至</span>
                                    <input type="date" name="cycleEnd" class="layui-input">
                                </div>
                            </div>

                            <div class="layui-form-item">
                                <label class="layui-form-label">产品范围</label>
                                <div class="layui-input-block">
                                    <select name="productScope">
                                        <option value="all" selected>全部产品</option>
                                        <option value="category">按类别筛选</option>
                                        <option value="low_stock">仅低库存产品</option>
                                        <option value="custom">自定义产品</option>
                                    </select>
                                </div>
                            </div>

                            <div class="layui-form-item" id="categoryFilterContainer" style="display: none;">
                                <label class="layui-form-label">产品类别</label>
                                <div class="layui-input-block">
                                    <select name="categoryId" multiple>
                                        <option value="1">面部护理</option>
                                        <option value="2">唇部护理</option>
                                        <option value="3">头发护理</option>
                                        <option value="4">香水香氛</option>
                                        <option value="5">面膜类</option>
                                    </select>
                                </div>
                            </div>

                            <div class="layui-form-item">
                                <label class="layui-form-label">需求生成方式</label>
                                <div class="layui-input-block">
                                    <input type="radio" name="generateMode" value="auto" title="自动生成" checked>
                                    <input type="radio" name="generateMode" value="semi" title="半自动生成">
                                    <input type="radio" name="generateMode" value="manual" title="手动录入">
                                </div>
                            </div>

                            <div class="layui-form-item">
                                <label class="layui-form-label">需求备注</label>
                                <div class="layui-input-block">
                                    <textarea name="demandRemarks" class="layui-textarea" rows="3" 
                                        placeholder="请输入其他需要说明的信息，如促销活动、季节性调整等"></textarea>
                                </div>
                            </div>

                            <div class="layui-form-item">
                                <div class="layui-input-block" style="margin-left: 150px;">
                                    <button class="layui-btn" lay-submit lay-filter="generateDemand">
                                        <i class="fa fa-magic"></i> 生成采购需求
                                    </button>
                                    <button type="button" class="layui-btn layui-btn-normal" lay-filter="previewDemand">
                                        <i class="fa fa-eye"></i> 预览需求
                                    </button>
                                    <button type="reset" class="layui-btn layui-btn-primary">
                                        <i class="fa fa-refresh"></i> 重置
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- 待确认需求 -->
                    <div class="layui-tab-item" id="pendingTab">
                        <div class="search-bar">
                            <div class="layui-input-group search-input">
                                <input type="text" placeholder="搜索需求单号、产品名称" class="layui-input" id="pendingSearch">
                                <div class="layui-input-group-addon">
                                    <button class="layui-btn" id="searchPending">
                                        <i class="fa fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <select name="pendingStatus" id="pendingStatus">
                                    <option value="">全部状态</option>
                                    <option value="draft">草稿</option>
                                    <option value="generated">已生成</option>
                                </select>
                            </div>
                            <button class="layui-btn layui-btn-primary" id="refreshPending">
                                <i class="fa fa-refresh"></i> 刷新
                            </button>
                        </div>

                        <div class="batch-operate">
                            <button class="layui-btn layui-btn-normal" id="batchConfirm">
                                <i class="fa fa-check"></i> 批量确认选中需求
                            </button>
                            <button class="layui-btn layui-btn-danger" id="batchCancel">
                                <i class="fa fa-times"></i> 批量取消选中需求
                            </button>
                        </div>

                        <table class="layui-table demand-table" lay-size="sm">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" lay-skin="primary" id="checkAllPending">
                                    </th>
                                    <th>需求单号</th>
                                    <th>需求日期</th>
                                    <th>目标仓库</th>
                                    <th>补货策略</th>
                                    <th>产品数量</th>
                                    <th>预估总金额</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="pendingTableBody">
                                <!-- 待确认数据将通过JS渲染 -->
                            </tbody>
                        </table>

                        <div id="pendingPagination" style="text-align: right; margin-top: 10px;"></div>
                    </div>

                    <!-- 历史采购需求 -->
                    <div class="layui-tab-item" id="historyTab">
                        <div class="search-bar">
                            <div class="layui-input-group search-input">
                                <input type="text" placeholder="搜索需求单号、仓库" class="layui-input" id="historySearch">
                                <div class="layui-input-group-addon">
                                    <button class="layui-btn" id="searchHistory">
                                        <i class="fa fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <select name="historyStatus" id="historyStatus">
                                    <option value="">全部状态</option>
                                    <option value="confirmed">已确认</option>
                                    <option value="canceled">已取消</option>
                                </select>
                            </div>
                            <div class="layui-form-item">
                                <select name="historyDateRange" id="historyDateRange">
                                    <option value="">全部时间</option>
                                    <option value="week">近一周</option>
                                    <option value="month">近一个月</option>
                                    <option value="quarter">近三个月</option>
                                    <option value="year">近一年</option>
                                </select>
                            </div>
                        </div>

                        <table class="layui-table demand-table" lay-size="sm">
                            <thead>
                                <tr>
                                    <th>需求单号</th>
                                    <th>需求日期</th>
                                    <th>目标仓库</th>
                                    <th>补货策略</th>
                                    <th>产品数量</th>
                                    <th>预估总金额</th>
                                    <th>确认时间</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- 历史数据将通过JS渲染 -->
                            </tbody>
                        </table>

                        <div id="historyPagination" style="text-align: right; margin-top: 10px;"></div>
                    </div>

                    <!-- 补货策略设置 -->
                    <div class="layui-tab-item" id="settingsTab">
                        <button class="layui-btn" id="addStrategy">
                            <i class="fa fa-plus"></i> 添加新策略
                        </button>

                        <div class="layui-card" style="margin-top: 15px;">
                            <div class="layui-card-header">
                                <i class="fa fa-cogs"></i> 现有补货策略
                            </div>
                            <div class="layui-card-body">
                                <div id="strategyList">
                                    <!-- 策略数据将通过JS渲染 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 采购需求详情弹窗 -->
    <div class="layui-modal" id="demandDetailModal" style="display: none; width: 900px;">
        <div class="layui-modal-title">
            <i class="fa fa-list-alt"></i> 采购需求详情 - <span id="detailDemandNo"></span>
        </div>
        <div class="layui-modal-body" style="max-height: 500px; overflow-y: auto; padding: 20px;">
            <div class="demand-summary">
                <div class="summary-item">
                    <div>需求日期</div>
                    <div class="summary-value" id="detailDemandDate"></div>
                </div>
                <div class="summary-item">
                    <div>目标仓库</div>
                    <div class="summary-value" id="detailWarehouseName"></div>
                </div>
                <div class="summary-item">
                    <div>补货策略</div>
                    <div class="summary-value" id="detailStrategyName"></div>
                </div>
                <div class="summary-item">
                    <div>需求周期</div>
                    <div class="summary-value" id="detailDemandCycle"></div>
                </div>
                <div class="summary-item">
                    <div>产品总数</div>
                    <div class="summary-value" id="detailProductCount"></div>
                </div>
                <div class="summary-item">
                    <div>预估总金额</div>
                    <div class="summary-value" id="detailTotalAmount"></div>
                </div>
            </div>
            
            <div style="margin: 15px 0;">
                <strong>需求备注：</strong>
                <p id="detailDemandRemarks" style="margin-top: 5px; color: #666;"></p>
            </div>
            
            <div>
                <strong>需求产品列表：</strong>
                <table class="layui-table demand-table" lay-size="sm">
                    <thead>
                        <tr>
                            <th style="width: 40px;">序号</th>
                            <th>产品编码</th>
                            <th>产品名称</th>
                            <th>规格</th>
                            <th>当前库存</th>
                            <th>安全库存</th>
                            <th>月均销量</th>
                            <th>建议采购量</th>
                            <th>预估单价(元)</th>
                            <th>预估金额(元)</th>
                            <th id="adjustColumn" style="display: none;">调整</th>
                        </tr>
                    </thead>
                    <tbody id="detailProductTableBody">
                        <!-- 详情数据将通过JS渲染 -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="layui-modal-footer" id="detailFooter">
            <button class="layui-btn layui-btn-primary" id="closeDetail">关闭</button>
        </div>
    </div>

    <!-- 策略编辑弹窗 -->
    <div class="layui-modal" id="strategyModal" style="display: none; width: 600px;">
        <div class="layui-modal-title">
            <i class="fa fa-cog"></i> <span id="strategyModalTitle">添加补货策略</span>
        </div>
        <div class="layui-modal-body" style="padding: 20px;">
            <form class="layui-form" lay-filter="strategyForm">
                <input type="hidden" name="strategyId" id="strategyId">
                
                <div class="layui-form-item">
                    <label class="layui-form-label">
                        <span class="required">*</span>策略名称
                    </label>
                    <div class="layui-input-block">
                        <input type="text" name="strategyName" lay-verify="required" class="layui-input" 
                            placeholder="请输入策略名称">
                    </div>
                </div>
                
                <div class="layui-form-item">
                    <label class="layui-form-label">
                        <span class="required">*</span>策略类型
                    </label>
                    <div class="layui-input-block">
                        <select name="strategyType" lay-verify="required">
                            <option value="safety">安全库存策略</option>
                            <option value="forecast">销售预测策略</option>
                            <option value="minimum">最小库存策略</option>
                            <option value="custom">自定义策略</option>
                        </select>
                    </div>
                </div>
                
                <div class="layui-form-item" id="safetyStockContainer">
                    <label class="layui-form-label">安全库存系数</label>
                    <div class="layui-input-block">
                        <input type="number" name="safetyFactor" class="layui-input" value="1.5" min="0.1" step="0.1"
                            placeholder="安全库存 = 平均日销量 × 补货周期 × 系数">
                    </div>
                </div>
                
                <div class="layui-form-item" id="forecastContainer" style="display: none;">
                    <label class="layui-form-label">预测周期</label>
                    <div class="layui-input-block">
                        <select name="forecastPeriod">
                            <option value="7">7天</option>
                            <option value="15">15天</option>
                            <option value="30" selected>30天</option>
                            <option value="60">60天</option>
                        </select>
                    </div>
                </div>
                
                <div class="layui-form-item" id="minimumStockContainer" style="display: none;">
                    <label class="layui-form-label">最小库存阈值</label>
                    <div class="layui-input-block">
                        <input type="number" name="minimumStock" class="layui-input" value="10" min="1"
                            placeholder="低于此数量将触发采购">
                    </div>
                </div>
                
                <div class="layui-form-item">
                    <label class="layui-form-label">适用仓库</label>
                    <div class="layui-input-block">
                        <select name="applicableWarehouses" multiple>
                            <option value="0" selected>全部仓库</option>
                            <option value="1">总仓</option>
                            <option value="2">华东分仓</option>
                            <option value="3">华南分仓</option>
                            <option value="4">华北分仓</option>
                        </select>
                    </div>
                </div>
                
                <div class="layui-form-item">
                    <label class="layui-form-label">适用产品类别</label>
                    <div class="layui-input-block">
                        <select name="applicableCategories" multiple>
                            <option value="0" selected>全部类别</option>
                            <option value="1">面部护理</option>
                            <option value="2">唇部护理</option>
                            <option value="3">头发护理</option>
                            <option value="4">香水香氛</option>
                            <option value="5">面膜类</option>
                        </select>
                    </div>
                </div>
                
                <div class="layui-form-item">
                    <label class="layui-form-label">策略描述</label>
                    <div class="layui-input-block">
                        <textarea name="strategyDesc" class="layui-textarea" rows="3" 
                            placeholder="请描述此策略的具体规则和应用场景"></textarea>
                    </div>
                </div>
            </form>
        </div>
        <div class="layui-modal-footer">
            <button class="layui-btn layui-btn-primary" id="cancelStrategy">取消</button>
            <button class="layui-btn" lay-submit lay-filter="saveStrategy">保存策略</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/layui-src/dist/layui.js"></script>
    <script>
        layui.use(['form', 'layer', 'laypage', 'element'], function() {
            var form = layui.form,
                layer = layui.layer,
                laypage = layui.laypage,
                element = layui.element;

            // 仓库数据
            var warehouses = [
                {id: 0, name: "全部仓库"},
                {id: 1, name: "总仓"},
                {id: 2, name: "华东分仓"},
                {id: 3, name: "华南分仓"},
                {id: 4, name: "华北分仓"}
            ];

            // 产品数据及各仓库库存信息
            var products = [
                {id: 1, code: "CP001", name: "水润保湿精华液", spec: "50ml", category: "面部护理",
                 stock: {1: 8, 2: 18, 3: 12, 4: 20},
                 safetyStock: {1: 15, 2: 15, 3: 10, 4: 15},
                 monthlySales: 25, price: 128},
                {id: 2, code: "CP002", name: "丝绒哑光口红", spec: "3.5g", category: "唇部护理",
                 stock: {1: 36, 2: 25, 3: 30, 4: 15},
                 safetyStock: {1: 20, 2: 20, 3: 20, 4: 15},
                 monthlySales: 32, price: 89},
                {id: 3, code: "CP003", name: "修护洗发水", spec: "300ml", category: "头发护理",
                 stock: {1: 5, 2: 12, 3: 5, 4: 10},
                 safetyStock: {1: 10, 2: 10, 3: 8, 4: 8},
                 monthlySales: 18, price: 68},
                {id: 4, code: "CP004", name: "男士古龙香水", spec: "100ml", category: "香水香氛",
                 stock: {1: 15, 2: 8, 3: 12, 4: 5},
                 safetyStock: {1: 10, 2: 8, 3: 10, 4: 8},
                 monthlySales: 12, price: 198},
                {id: 5, code: "CP005", name: "焕白面膜", spec: "10片装", category: "面膜类",
                 stock: {1: 12, 2: 30, 3: 25, 4: 35},
                 safetyStock: {1: 20, 2: 25, 3: 20, 4: 25},
                 monthlySales: 45, price: 158},
                {id: 6, code: "CP006", name: "温和洁面乳", spec: "120g", category: "面部护理",
                 stock: {1: 28, 2: 22, 3: 18, 4: 25},
                 safetyStock: {1: 20, 2: 18, 3: 15, 4: 20},
                 monthlySales: 30, price: 59},
                {id: 7, code: "CP007", name: "保湿面霜", spec: "50g", category: "面部护理",
                 stock: {1: 4, 2: 15, 3: 20, 4: 12},
                 safetyStock: {1: 12, 2: 12, 3: 15, 4: 10},
                 monthlySales: 22, price: 108},
                {id: 8, code: "CP008", name: "防晒霜", spec: "60ml", category: "面部护理",
                 stock: {1: 32, 2: 28, 3: 35, 4: 24},
                 safetyStock: {1: 25, 2: 25, 3: 30, 4: 20},
                 monthlySales: 15, price: 98}
            ];

            // 补货策略数据
            var strategies = [
                {
                    id: 1,
                    name: "安全库存策略",
                    type: "safety",
                    typeText: "安全库存策略",
                    safetyFactor: 1.5,
                    applicableWarehouses: [0],
                    applicableCategories: [0],
                    desc: "基于安全库存的自动补货策略，当实际库存低于安全库存时生成采购需求"
                },
                {
                    id: 2,
                    name: "月度销售预测策略",
                    type: "forecast",
                    typeText: "销售预测策略",
                    forecastPeriod: 30,
                    applicableWarehouses: [0],
                    applicableCategories: [0],
                    desc: "根据过去3个月的销售数据预测未来30天的销售量，并生成相应采购需求"
                },
                {
                    id: 3,
                    name: "最小库存策略",
                    type: "minimum",
                    typeText: "最小库存策略",
                    minimumStock: 10,
                    applicableWarehouses: [1, 2, 3, 4],
                    applicableCategories: [1, 2, 3, 4, 5],
                    desc: "当产品库存低于最小阈值时生成采购需求，适用于各分仓的常规补货"
                }
            ];

            // 模拟待确认需求数据
            var pendingData = [
                {
                    id: 1,
                    demandNo: "PR202310160001",
                    demandDate: "2023-10-16",
                    warehouseId: 1,
                    warehouseName: "总仓",
                    strategyId: 1,
                    strategyName: "安全库存策略",
                    demandCycle: "month",
                    demandCycleText: "下一个月",
                    productCount: 3,
                    totalAmount: 5840,
                    status: "generated",
                    statusText: "已生成",
                    remarks: "月度例行补货，包含多个低库存产品",
                    products: [
                        {productId: 1, code: "CP001", name: "水润保湿精华液", spec: "50ml", 
                         currentStock: 8, safetyStock: 15, monthlySales: 25, 
                         suggestedQty: 22, price: 128, amount: 2816},
                        {productId: 3, code: "CP003", name: "修护洗发水", spec: "300ml", 
                         currentStock: 5, safetyStock: 10, monthlySales: 18, 
                         suggestedQty: 23, price: 68, amount: 1564},
                        {productId: 7, code: "CP007", name: "保湿面霜", spec: "50g", 
                         currentStock: 4, safetyStock: 12, monthlySales: 22, 
                         suggestedQty: 30, price: 108, amount: 3240}
                    ]
                },
                {
                    id: 2,
                    demandNo: "PR202310150002",
                    demandDate: "2023-10-15",
                    warehouseId: 0,
                    warehouseName: "全部仓库",
                    strategyId: 2,
                    strategyName: "月度销售预测策略",
                    demandCycle: "month",
                    demandCycleText: "下一个月",
                    productCount: 2,
                    totalAmount: 8920,
                    status: "draft",
                    statusText: "草稿",
                    remarks: "季度促销准备，增加面膜和防晒霜采购量",
                    products: [
                        {productId: 5, code: "CP005", name: "焕白面膜", spec: "10片装", 
                         currentStock: 12, safetyStock: 20, monthlySales: 45, 
                         suggestedQty: 60, price: 158, amount: 9480},
                        {productId: 8, code: "CP008", name: "防晒霜", spec: "60ml", 
                         currentStock: 32, safetyStock: 25, monthlySales: 15, 
                         suggestedQty: 25, price: 98, amount: 2450}
                    ]
                }
            ];

            // 模拟历史需求数据
            var historyData = [
                {
                    id: 3,
                    demandNo: "PR202309300001",
                    demandDate: "2023-09-30",
                    warehouseId: 2,
                    warehouseName: "华东分仓",
                    strategyId: 3,
                    strategyName: "最小库存策略",
                    demandCycle: "month",
                    demandCycleText: "下一个月",
                    productCount: 4,
                    totalAmount: 12560,
                    confirmTime: "2023-10-01 10:20:30",
                    status: "confirmed",
                    statusText: "已确认",
                    products: [
                        {productId: 1, name: "水润保湿精华液", spec: "50ml", suggestedQty: 20, amount: 2560},
                        {productId: 2, name: "丝绒哑光口红", spec: "3.5g", suggestedQty: 30, amount: 2670},
                        {productId: 4, name: "男士古龙香水", spec: "100ml", suggestedQty: 15, amount: 2970},
                        {productId: 6, name: "温和洁面乳", spec: "120g", suggestedQty: 40, amount: 2360}
                    ]
                },
                {
                    id: 4,
                    demandNo: "PR202309250001",
                    demandDate: "2023-09-25",
                    warehouseId: 3,
                    warehouseName: "华南分仓",
                    strategyId: 1,
                    strategyName: "安全库存策略",
                    demandCycle: "week",
                    demandCycleText: "下周",
                    productCount: 2,
                    totalAmount: 3840,
                    confirmTime: "2023-09-26 14:35:15",
                    status: "confirmed",
                    statusText: "已确认",
                    products: [
                        {productId: 3, name: "修护洗发水", spec: "300ml", suggestedQty: 30, amount: 2040},
                        {productId: 7, name: "保湿面霜", spec: "50g", suggestedQty: 17, amount: 1836}
                    ]
                },
                {
                    id: 5,
                    demandNo: "PR202309200001",
                    demandDate: "2023-09-20",
                    warehouseId: 4,
                    warehouseName: "华北分仓",
                    strategyId: 2,
                    strategyName: "月度销售预测策略",
                    demandCycle: "month",
                    demandCycleText: "下一个月",
                    productCount: 3,
                    totalAmount: 7520,
                    confirmTime: "2023-09-21 09:15:40",
                    status: "canceled",
                    statusText: "已取消",
                    products: [
                        {productId: 2, name: "丝绒哑光口红", spec: "3.5g", suggestedQty: 25, amount: 2225},
                        {productId: 5, name: "焕白面膜", spec: "10片装", suggestedQty: 20, amount: 3160},
                        {productId: 8, name: "防晒霜", spec: "60ml", suggestedQty: 23, amount: 2254}
                    ]
                }
            ];

            // 生成需求单号
            function generateDemandNo() {
                var date = new Date();
                var year = date.getFullYear();
                var month = (date.getMonth() + 1).toString().padStart(2, '0');
                var day = date.getDate().toString().padStart(2, '0');
                var random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
                return "PR" + year + month + day + random;
            }

            // 初始化需求单号
            $('#demandNo').val(generateDemandNo());

            // 设置默认日期为今天
            var today = new Date().toISOString().split('T')[0];
            $('input[name="demandDate"]').val(today);

            // 需求周期变更事件
            form.on('select(demandCycle)', function(data) {
                if (data.value === 'custom') {
                    $('#customCycleContainer').show();
                } else {
                    $('#customCycleContainer').hide();
                }
            });

            // 产品范围变更事件
            form.on('select(productScope)', function(data) {
                if (data.value === 'category') {
                    $('#categoryFilterContainer').show();
                } else {
                    $('#categoryFilterContainer').hide();
                }
            });

            // 策略类型变更事件
            form.on('select(strategyType)', function(data) {
                // 隐藏所有策略参数容器
                $('#safetyStockContainer').hide();
                $('#forecastContainer').hide();
                $('#minimumStockContainer').hide();
                
                // 根据策略类型显示对应的参数容器
                switch(data.value) {
                    case 'safety':
                        $('#safetyStockContainer').show();
                        break;
                    case 'forecast':
                        $('#forecastContainer').show();
                        break;
                    case 'minimum':
                        $('#minimumStockContainer').show();
                        break;
                    case 'custom':
                        // 自定义策略可以显示所有参数或自定义表单
                        $('#safetyStockContainer').show();
                        $('#forecastContainer').show();
                        break;
                }
            });

            // 预览采购需求
            form.on('button(previewDemand)', function() {
                // 简单验证
                if (!$('#warehouseSelect').val()) {
                    layer.msg('请选择目标仓库', {icon: 2});
                    return;
                }
                
                if (!$('#strategySelect').val()) {
                    layer.msg('请选择补货策略', {icon: 2});
                    return;
                }
                
                // 生成预览数据
                generateDemandData(true);
            });

            // 生成采购需求
            form.on('submit(generateDemand)', function(data) {
                // 验证
                if (!$('#warehouseSelect').val()) {
                    layer.msg('请选择目标仓库', {icon: 2});
                    return false;
                }
                
                if (!$('#strategySelect').val()) {
                    layer.msg('请选择补货策略', {icon: 2});
                    return false;
                }
                
                // 生成正式需求数据
                generateDemandData(false);
                return false;
            });

            // 生成需求数据
            function generateDemandData(isPreview) {
                var warehouseId = parseInt($('#warehouseSelect').val());
                var strategyId = parseInt($('#strategySelect').val());
                var strategy = strategies.find(s => s.id === strategyId);
                var demandNo = $('#demandNo').val();
                var demandDate = $('input[name="demandDate"]').val();
                var demandCycle = $('select[name="demandCycle"]').val();
                var demandCycleText = $('select[name="demandCycle"] option:selected').text();
                var remarks = $('textarea[name="demandRemarks"]').val();
                
                // 根据仓库和策略生成采购需求
                var demandProducts = [];
                var warehouseName = warehouses.find(w => w.id === warehouseId)?.name || '';
                var strategyName = strategy?.name || '';
                
                // 筛选适用产品
                var targetProducts = [...products];
                
                // 如果选择了特定仓库，只考虑该仓库的库存
                if (warehouseId > 0) {
                    targetProducts.forEach(product => {
                        // 根据策略计算建议采购量
                        var suggestedQty = calculateSuggestedQty(product, warehouseId, strategy);
                        if (suggestedQty > 0) {
                            demandProducts.push({
                                productId: product.id,
                                code: product.code,
                                name: product.name,
                                spec: product.spec,
                                currentStock: product.stock[warehouseId] || 0,
                                safetyStock: product.safetyStock[warehouseId] || 0,
                                monthlySales: product.monthlySales,
                                suggestedQty: suggestedQty,
                                price: product.price,
                                amount: suggestedQty * product.price
                            });
                        }
                    });
                } else {
                    // 全部仓库，这里简化处理，只取总仓数据
                    targetProducts.forEach(product => {
                        var suggestedQty = calculateSuggestedQty(product, 1, strategy);
                        if (suggestedQty > 0) {
                            demandProducts.push({
                                productId: product.id,
                                code: product.code,
                                name: product.name,
                                spec: product.spec,
                                currentStock: product.stock[1] || 0,
                                safetyStock: product.safetyStock[1] || 0,
                                monthlySales: product.monthlySales,
                                suggestedQty: suggestedQty,
                                price: product.price,
                                amount: suggestedQty * product.price
                            });
                        }
                    });
                }
                
                // 如果没有生成任何需求产品
                if (demandProducts.length === 0) {
                    layer.msg('根据当前条件，没有需要采购的产品', {icon: 1});
                    return;
                }
                
                // 计算总金额
                var totalAmount = demandProducts.reduce((sum, item) => sum + item.amount, 0);
                
                // 创建需求数据对象
                var demandData = {
                    id: pendingData.length + 1,
                    demandNo: demandNo,
                    demandDate: demandDate,
                    warehouseId: warehouseId,
                    warehouseName: warehouseName,
                    strategyId: strategyId,
                    strategyName: strategyName,
                    demandCycle: demandCycle,
                    demandCycleText: demandCycleText,
                    productCount: demandProducts.length,
                    totalAmount: totalAmount,
                    status: isPreview ? 'generated' : 'generated',
                    statusText: isPreview ? '预览' : '已生成',
                    remarks: remarks,
                    products: demandProducts
                };
                
                // 如果不是预览，添加到待确认列表
                if (!isPreview) {
                    pendingData.unshift(demandData);
                    renderPendingList();
                }
                
                // 显示需求详情
                showDemandDetail(demandData, isPreview);
            }

            // 根据策略计算建议采购量
            function calculateSuggestedQty(product, warehouseId, strategy) {
                var currentStock = product.stock[warehouseId] || 0;
                
                // 根据不同策略计算建议采购量
                switch(strategy.type) {
                    case 'safety':
                        // 安全库存策略：建议采购量 = 安全库存 × 1.2 - 当前库存
                        var safetyStock = product.safetyStock[warehouseId] || 0;
                        var suggestedQty = Math.ceil(safetyStock * 1.2 - currentStock);
                        return Math.max(0, suggestedQty);
                        
                    case 'forecast':
                        // 销售预测策略：建议采购量 = 未来30天预测销量 - 当前库存
                        var forecastPeriod = strategy.forecastPeriod || 30;
                        var dailySales = product.monthlySales / 30;
                        var forecastSales = Math.ceil(dailySales * forecastPeriod);
                        var suggestedQty = forecastSales - currentStock;
                        return Math.max(0, suggestedQty);
                        
                    case 'minimum':
                        // 最小库存策略：建议采购量 = 最小库存阈值 × 2 - 当前库存
                        var minStock = strategy.minimumStock || 10;
                        var suggestedQty = minStock * 2 - currentStock;
                        return Math.max(0, suggestedQty);
                        
                    default:
                        // 默认使用安全库存策略
                        var safetyStock = product.safetyStock[warehouseId] || 0;
                        var suggestedQty = Math.ceil(safetyStock * 1.2 - currentStock);
                        return Math.max(0, suggestedQty);
                }
            }

            // 显示需求详情
            function showDemandDetail(demandData, isPreview) {
                $('#detailDemandNo').text(demandData.demandNo);
                $('#detailDemandDate').text(demandData.demandDate);
                $('#detailWarehouseName').text(demandData.warehouseName);
                $('#detailStrategyName').text(demandData.strategyName);
                $('#detailDemandCycle').text(demandData.demandCycleText);
                $('#detailProductCount').text(demandData.productCount);
                $('#detailTotalAmount').text(demandData.totalAmount.toFixed(2) + ' 元');
                $('#detailDemandRemarks').text(demandData.remarks || '无');
                
                // 渲染产品列表
                var html = '';
                demandData.products.forEach((product, index) => {
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${product.code}</td>
                            <td>${product.name}</td>
                            <td>${product.spec}</td>
                            <td>${product.currentStock} ${product.currentStock < product.safetyStock ? '<span class="warning-tag">↓</span>' : ''}</td>
                            <td>${product.safetyStock}</td>
                            <td>${product.monthlySales}</td>
                            <td>
                                <input type="number" class="layui-input" value="${product.suggestedQty}" 
                                    min="0" data-id="${product.productId}" ${isPreview ? '' : 'readonly'}>
                            </td>
                            <td>${product.price.toFixed(2)}</td>
                            <td>${product.amount.toFixed(2)}</td>
                        </tr>
                    `;
                });
                $('#detailProductTableBody').html(html);
                
                // 根据是否预览显示不同按钮
                var footerHtml = '';
                if (isPreview) {
                    footerHtml = `
                        <button class="layui-btn layui-btn-primary" id="closeDetail">关闭预览</button>
                        <button class="layui-btn" id="saveAsDraft">保存为草稿</button>
                        <button class="layui-btn layui-btn-normal" id="generateFromPreview">生成正式需求</button>
                    `;
                } else {
                    footerHtml = `
                        <button class="layui-btn layui-btn-primary" id="closeDetail">关闭</button>
                        <button class="layui-btn layui-btn-danger" id="cancelDemand" data-id="${demandData.id}">取消需求</button>
                        <button class="layui-btn" id="confirmDemand" data-id="${demandData.id}">确认需求</button>
                    `;
                }
                $('#detailFooter').html(footerHtml);
                
                // 绑定临时按钮事件
                if (isPreview) {
                    $('#saveAsDraft').off('click').on('click', function() {
                        // 保存为草稿
                        demandData.status = 'draft';
                        demandData.statusText = '草稿';
                        pendingData.unshift(demandData);
                        renderPendingList();
                        
                        $('#demandDetailModal').hide();
                        $('.layui-modal-shade').remove();
                        layer.msg('已保存为草稿', {icon: 1});
                    });
                    
                    $('#generateFromPreview').off('click').on('click', function() {
                        // 生成正式需求
                        demandData.status = 'generated';
                        demandData.statusText = '已生成';
                        pendingData.unshift(demandData);
                        renderPendingList();
                        
                        $('#demandDetailModal').hide();
                        $('.layui-modal-shade').remove();
                        layer.msg('采购需求已生成', {icon: 1});
                        
                        // 生成新的需求单号
                        $('#demandNo').val(generateDemandNo());
                    });
                } else {
                    $('#confirmDemand').off('click').on('click', function() {
                        var demandId = parseInt($(this).attr('data-id'));
                        confirmDemand(demandId);
                    });
                    
                    $('#cancelDemand').off('click').on('click', function() {
                        var demandId = parseInt($(this).attr('data-id'));
                        cancelDemand(demandId);
                    });
                }
                
                $('#demandDetailModal').show();
                $('body').append('<div class="layui-modal-shade"></div>');
            }

            // 查看需求详情
            window.viewDemandDetail = function(id, type) {
                var demandData = null;
                if (type === 'pending') {
                    demandData = pendingData.find(item => item.id === id);
                } else if (type === 'history') {
                    demandData = historyData.find(item => item.id === id);
                }
                
                if (!demandData) return;
                
                $('#detailDemandNo').text(demandData.demandNo);
                $('#detailDemandDate').text(demandData.demandDate);
                $('#detailWarehouseName').text(demandData.warehouseName);
                $('#detailStrategyName').text(demandData.strategyName);
                $('#detailDemandCycle').text(demandData.demandCycleText);
                $('#detailProductCount').text(demandData.productCount);
                $('#detailTotalAmount').text(demandData.totalAmount.toFixed(2) + ' 元');
                $('#detailDemandRemarks').text(demandData.remarks || '无');
                
                // 渲染产品列表
                var html = '';
                demandData.products.forEach((product, index) => {
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${product.code || '-'}</td>
                            <td>${product.name}</td>
                            <td>${product.spec}</td>
                            <td>${product.currentStock || '-'}</td>
                            <td>${product.safetyStock || '-'}</td>
                            <td>${product.monthlySales || '-'}</td>
                            <td>${product.suggestedQty}</td>
                            <td>${product.price ? product.price.toFixed(2) : '-'}</td>
                            <td>${product.amount ? product.amount.toFixed(2) : '-'}</td>
                        </tr>
                    `;
                });
                $('#detailProductTableBody').html(html);
                
                // 根据类型显示不同按钮
                var footerHtml = '';
                if (type === 'pending') {
                    footerHtml = `
                        <button class="layui-btn layui-btn-primary" id="closeDetail">关闭</button>
                        <button class="layui-btn layui-btn-danger" id="cancelDemand" data-id="${demandData.id}">取消需求</button>
                        <button class="layui-btn" id="confirmDemand" data-id="${demandData.id}">确认需求</button>
                    `;
                } else {
                    footerHtml = `
                        <button class="layui-btn" id="closeDetail">关闭</button>
                    `;
                }
                $('#detailFooter').html(footerHtml);
                
                // 绑定按钮事件
                if (type === 'pending') {
                    $('#confirmDemand').off('click').on('click', function() {
                        var demandId = parseInt($(this).attr('data-id'));
                        confirmDemand(demandId);
                    });
                    
                    $('#cancelDemand').off('click').on('click', function() {
                        var demandId = parseInt($(this).attr('data-id'));
                        cancelDemand(demandId);
                    });
                }
                
                $('#demandDetailModal').show();
                $('body').append('<div class="layui-modal-shade"></div>');
            };

            // 确认需求
            function confirmDemand(demandId) {
                layer.confirm('确定要确认此采购需求吗？确认后将进入采购流程。', {
                    icon: 3,
                    title: '确认采购需求'
                }, function(index) {
                    layer.close(index);
                    
                    // 从待确认列表移除
                    var itemIndex = pendingData.findIndex(item => item.id === demandId);
                    if (itemIndex !== -1) {
                        var item = pendingData.splice(itemIndex, 1)[0];
                        
                        // 更新状态
                        item.status = 'confirmed';
                        item.statusText = '已确认';
                        item.confirmTime = new Date().toLocaleString();
                        
                        // 添加到历史列表
                        historyData.unshift(item);
                        renderHistoryList();
                        
                        // 刷新待确认列表
                        renderPendingList();
                        
                        // 关闭详情弹窗
                        $('#demandDetailModal').hide();
                        $('.layui-modal-shade').remove();
                        
                        layer.msg('采购需求已确认', {icon: 1, time: 1500});
                    }
                });
            }

            // 取消需求
            function cancelDemand(demandId) {
                layer.confirm('确定要取消此采购需求吗？', {
                    icon: 3,
                    title: '取消采购需求'
                }, function(index) {
                    layer.close(index);
                    
                    // 从待确认列表移除
                    var itemIndex = pendingData.findIndex(item => item.id === demandId);
                    if (itemIndex !== -1) {
                        var item = pendingData.splice(itemIndex, 1)[0];
                        
                        // 更新状态
                        item.status = 'canceled';
                        item.statusText = '已取消';
                        item.confirmTime = new Date().toLocaleString();
                        
                        // 添加到历史列表
                        historyData.unshift(item);
                        renderHistoryList();
                        
                        // 刷新待确认列表
                        renderPendingList();
                        
                        // 关闭详情弹窗
                        $('#demandDetailModal').hide();
                        $('.layui-modal-shade').remove();
                        
                        layer.msg('采购需求已取消', {icon: 1, time: 1500});
                    }
                });
            }

            // 批量确认需求
            $('#batchConfirm').click(function() {
                var checkedItems = $('#pendingTableBody [type="checkbox"]:checked');
                if (checkedItems.length === 0) {
                    layer.msg('请先选择需要确认的需求', {icon: 2});
                    return;
                }
                
                layer.confirm(`确定要批量确认选中的${checkedItems.length}条需求吗？`, {
                    icon: 3,
                    title: '批量确认采购需求'
                }, function(index) {
                    layer.close(index);
                    
                    // 模拟批量确认
                    var processIndex = layer.load(2);
                    setTimeout(function() {
                        layer.close(processIndex);
                        
                        checkedItems.each(function() {
                            var id = parseInt($(this).attr('data-id'));
                            var itemIndex = pendingData.findIndex(item => item.id === id);
                            if (itemIndex !== -1) {
                                var item = pendingData.splice(itemIndex, 1)[0];
                                
                                // 更新状态
                                item.status = 'confirmed';
                                item.statusText = '已确认';
                                item.confirmTime = new Date().toLocaleString();
                                
                                // 添加到历史列表
                                historyData.unshift(item);
                            }
                        });
                        
                        renderPendingList();
                        renderHistoryList();
                        layer.msg(`已成功确认${checkedItems.length}条需求`, {icon: 1});
                    }, 1000);
                });
            });

            // 批量取消需求
            $('#batchCancel').click(function() {
                var checkedItems = $('#pendingTableBody [type="checkbox"]:checked');
                if (checkedItems.length === 0) {
                    layer.msg('请先选择需要取消的需求', {icon: 2});
                    return;
                }
                
                layer.confirm(`确定要批量取消选中的${checkedItems.length}条需求吗？`, {
                    icon: 3,
                    title: '批量取消采购需求'
                }, function(index) {
                    layer.close(index);
                    
                    // 模拟批量取消
                    var processIndex = layer.load(2);
                    setTimeout(function() {
                        layer.close(processIndex);
                        
                        checkedItems.each(function() {
                            var id = parseInt($(this).attr('data-id'));
                            var itemIndex = pendingData.findIndex(item => item.id === id);
                            if (itemIndex !== -1) {
                                var item = pendingData.splice(itemIndex, 1)[0];
                                
                                // 更新状态
                                item.status = 'canceled';
                                item.statusText = '已取消';
                                item.confirmTime = new Date().toLocaleString();
                                
                                // 添加到历史列表
                                historyData.unshift(item);
                            }
                        });
                        
                        renderPendingList();
                        renderHistoryList();
                        layer.msg(`已成功取消${checkedItems.length}条需求`, {icon: 1});
                    }, 1000);
                });
            });

            // 关闭详情弹窗
            $(document).on('click', '#closeDetail', function() {
                $('#demandDetailModal').hide();
                $('.layui-modal-shade').remove();
            });

            // 添加新策略
            $('#addStrategy').click(function() {
                $('#strategyModalTitle').text('添加补货策略');
                $('#strategyId').val('');
                $('input[name="strategyName"]').val('');
                $('select[name="strategyType"]').val('safety');
                $('input[name="safetyFactor"]').val(1.5);
                $('select[name="forecastPeriod"]').val(30);
                $('input[name="minimumStock"]').val(10);
                $('select[name="applicableWarehouses"]').val(['0']);
                $('select[name="applicableCategories"]').val(['0']);
                $('textarea[name="strategyDesc"]').val('');
                
                // 显示安全库存策略参数
                $('#safetyStockContainer').show();
                $('#forecastContainer').hide();
                $('#minimumStockContainer').hide();
                
                $('#strategyModal').show();
                $('body').append('<div class="layui-modal-shade"></div>');
                form.render();
            });

            // 编辑策略
            window.editStrategy = function(id) {
                var strategy = strategies.find(s => s.id === id);
                if (!strategy) return;
                
                $('#strategyModalTitle').text('编辑补货策略');
                $('#strategyId').val(strategy.id);
                $('input[name="strategyName"]').val(strategy.name);
                $('select[name="strategyType"]').val(strategy.type);
                $('input[name="safetyFactor"]').val(strategy.safetyFactor || 1.5);
                $('select[name="forecastPeriod"]').val(strategy.forecastPeriod || 30);
                $('input[name="minimumStock"]').val(strategy.minimumStock || 10);
                $('select[name="applicableWarehouses"]').val(strategy.applicableWarehouses);
                $('select[name="applicableCategories"]').val(strategy.applicableCategories);
                $('textarea[name="strategyDesc"]').val(strategy.desc || '');
                
                // 根据策略类型显示对应的参数容器
                $('#safetyStockContainer').hide();
                $('#forecastContainer').hide();
                $('#minimumStockContainer').hide();
                
                switch(strategy.type) {
                    case 'safety':
                        $('#safetyStockContainer').show();
                        break;
                    case 'forecast':
                        $('#forecastContainer').show();
                        break;
                    case 'minimum':
                        $('#minimumStockContainer').show();
                        break;
                    case 'custom':
                        $('#safetyStockContainer').show();
                        $('#forecastContainer').show();
                        break;
                }
                
                $('#strategyModal').show();
                $('body').append('<div class="layui-modal-shade"></div>');
                form.render();
            };

            // 删除策略
            window.deleteStrategy = function(id) {
                var strategy = strategies.find(s => s.id === id);
                if (!strategy) return;
                
                layer.confirm(`确定要删除策略"${strategy.name}"吗？`, {
                    icon: 3,
                    title: '删除策略'
                }, function(index) {
                    layer.close(index);
                    
                    // 从策略列表移除
                    var itemIndex = strategies.findIndex(s => s.id === id);
                    if (itemIndex !== -1) {
                        strategies.splice(itemIndex, 1);
                        renderStrategyList();
                        layer.msg('策略已删除', {icon: 1});
                    }
                });
            };

            // 取消策略编辑
            $('#cancelStrategy').click(function() {
                $('#strategyModal').hide();
                $('.layui-modal-shade').remove();
            });

            // 保存策略
            form.on('submit(saveStrategy)', function(data) {
                var strategyId = $('#strategyId').val();
                var strategyData = data.field;
                
                // 构建策略对象
                var newStrategy = {
                    name: strategyData.strategyName,
                    type: strategyData.strategyType,
                    typeText: getStrategyTypeName(strategyData.strategyType),
                    applicableWarehouses: strategyData.applicableWarehouses ? 
                        (Array.isArray(strategyData.applicableWarehouses) ? 
                            strategyData.applicableWarehouses.map(Number) : [Number(strategyData.applicableWarehouses)]) : [],
                    applicableCategories: strategyData.applicableCategories ? 
                        (Array.isArray(strategyData.applicableCategories) ? 
                            strategyData.applicableCategories.map(Number) : [Number(strategyData.applicableCategories)]) : [],
                    desc: strategyData.strategyDesc
                };
                
                // 根据策略类型添加相应参数
                switch(strategyData.strategyType) {
                    case 'safety':
                        newStrategy.safetyFactor = parseFloat(strategyData.safetyFactor);
                        break;
                    case 'forecast':
                        newStrategy.forecastPeriod = parseInt(strategyData.forecastPeriod);
                        break;
                    case 'minimum':
                        newStrategy.minimumStock = parseInt(strategyData.minimumStock);
                        break;
                    case 'custom':
                        newStrategy.safetyFactor = parseFloat(strategyData.safetyFactor);
                        newStrategy.forecastPeriod = parseInt(strategyData.forecastPeriod);
                        break;
                }
                
                if (strategyId) {
                    // 更新现有策略
                    var itemIndex = strategies.findIndex(s => s.id === parseInt(strategyId));
                    if (itemIndex !== -1) {
                        newStrategy.id = parseInt(strategyId);
                        strategies[itemIndex] = newStrategy;
                    }
                } else {
                    // 添加新策略
                    newStrategy.id = strategies.length > 0 ? Math.max(...strategies.map(s => s.id)) + 1 : 1;
                    strategies.push(newStrategy);
                }
                
                // 关闭弹窗并刷新列表
                $('#strategyModal').hide();
                $('.layui-modal-shade').remove();
                renderStrategyList();
                layer.msg('策略已保存', {icon: 1});
                
                return false;
            });

            // 获取策略类型名称
            function getStrategyTypeName(type) {
                const typeMap = {
                    'safety': '安全库存策略',
                    'forecast': '销售预测策略',
                    'minimum': '最小库存策略',
                    'custom': '自定义策略'
                };
                return typeMap[type] || type;
            }

            // 渲染待确认列表
            function renderPendingList() {
                var html = '';
                pendingData.forEach(item => {
                    var statusClass = '';
                    switch(item.status) {
                        case 'draft':
                            statusClass = 'status-draft';
                            break;
                        case 'generated':
                            statusClass = 'status-generated';
                            break;
                    }
                    
                    html += `<tr>
                        <td><input type="checkbox" lay-skin="primary" data-id="${item.id}"></td>
                        <td>${item.demandNo}</td>
                        <td>${item.demandDate}</td>
                        <td>${item.warehouseName}</td>
                        <td>${item.strategyName}</td>
                        <td>${item.productCount}</td>
                        <td>￥${item.totalAmount.toFixed(2)}</td>
                        <td><span class="status-tag ${statusClass}">${item.statusText}</span></td>
                        <td>
                            <button class="layui-btn layui-btn-xs operate-btn" onclick="viewDemandDetail(${item.id}, 'pending')">
                                <i class="fa fa-eye"></i> 查看
                            </button>
                            <button class="layui-btn layui-btn-normal layui-btn-xs operate-btn" onclick="editDemand(${item.id})">
                                <i class="fa fa-edit"></i> 编辑
                            </button>
                        </td>
                    </tr>`;
                });
                $('#pendingTableBody').html(html);
                form.render('checkbox');
                
                // 渲染分页
                renderPendingPagination();
            }

            // 渲染待确认分页
            function renderPendingPagination() {
                laypage.render({
                    elem: 'pendingPagination',
                    count: pendingData.length,
                    limit: 10,
                    curr: 1,
                    layout: ['prev', 'page', 'next', 'count']
                });
            }

            // 渲染历史列表
            function renderHistoryList() {
                var html = '';
                historyData.forEach(item => {
                    var statusClass = item.status === 'confirmed' ? 'status-confirmed' : 'status-canceled';
                    
                    html += `<tr>
                        <td>${item.demandNo}</td>
                        <td>${item.demandDate}</td>
                        <td>${item.warehouseName}</td>
                        <td>${item.strategyName}</td>
                        <td>${item.productCount}</td>
                        <td>￥${item.totalAmount.toFixed(2)}</td>
                        <td>${item.confirmTime}</td>
                        <td><span class="status-tag ${statusClass}">${item.statusText}</span></td>
                        <td>
                            <button class="layui-btn layui-btn-xs operate-btn" onclick="viewDemandDetail(${item.id}, 'history')">
                                <i class="fa fa-eye"></i> 查看详情
                            </button>
                            <button class="layui-btn layui-btn-primary layui-btn-xs operate-btn" onclick="createOrderFromDemand(${item.id})">
                                <i class="fa fa-shopping-cart"></i> 生成订单
                            </button>
                        </td>
                    </tr>`;
                });
                $('#historyTableBody').html(html);
                
                // 渲染分页
                renderHistoryPagination();
            }

            // 渲染历史分页
            function renderHistoryPagination() {
                laypage.render({
                    elem: 'historyPagination',
                    count: historyData.length,
                    limit: 10,
                    curr: 1,
                    layout: ['prev', 'page', 'next', 'count']
                });
            }

            // 渲染策略列表
            function renderStrategyList() {
                var html = '';
                if (strategies.length === 0) {
                    html = '<div style="text-align: center; padding: 20px;">暂无补货策略，请添加新策略</div>';
                } else {
                    strategies.forEach(strategy => {
                        var paramsHtml = '';
                        switch(strategy.type) {
                            case 'safety':
                                paramsHtml = `<div><strong>安全库存系数：</strong>${strategy.safetyFactor}</div>`;
                                break;
                            case 'forecast':
                                paramsHtml = `<div><strong>预测周期：</strong>${strategy.forecastPeriod}天</div>`;
                                break;
                            case 'minimum':
                                paramsHtml = `<div><strong>最小库存阈值：</strong>${strategy.minimumStock}</div>`;
                                break;
                            case 'custom':
                                paramsHtml = `
                                    <div><strong>安全库存系数：</strong>${strategy.safetyFactor}</div>
                                    <div><strong>预测周期：</strong>${strategy.forecastPeriod}天</div>
                                `;
                                break;
                        }
                        
                        html += `
                            <div class="strategy-item" data-id="${strategy.id}">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${strategy.name}</strong>
                                        <span class="status-tag status-generated" style="margin-left: 10px;">${strategy.typeText}</span>
                                    </div>
                                    <div>
                                        <button class="layui-btn layui-btn-xs" onclick="editStrategy(${strategy.id})">
                                            <i class="fa fa-edit"></i> 编辑
                                        </button>
                                        <button class="layui-btn layui-btn-danger layui-btn-xs" onclick="deleteStrategy(${strategy.id})">
                                            <i class="fa fa-trash"></i> 删除
                                        </button>
                                    </div>
                                </div>
                                <div style="margin: 8px 0;">${paramsHtml}</div>
                                <div style="font-size: 12px; color: #666;">${strategy.desc || '无描述'}</div>
                            </div>
                        `;
                    });
                }
                $('#strategyList').html(html);
            }

            // 刷新待确认列表
            $('#refreshPending').click(function() {
                var index = layer.load(1);
                setTimeout(function() {
                    renderPendingList();
                    layer.close(index);
                    layer.msg('已刷新', {icon: 1, time: 1000});
                }, 500);
            });

            // 搜索待确认
            $('#searchPending').click(function() {
                var keyword = $('#pendingSearch').val().toLowerCase();
                var status = $('#pendingStatus').val();
                // 实际项目中这里应该根据关键词和状态筛选数据
                layer.msg('搜索: ' + keyword + ', 状态: ' + status, {icon: 1});
            });

            // 搜索历史
            $('#searchHistory').click(function() {
                var keyword = $('#historySearch').val().toLowerCase();
                var status = $('#historyStatus').val();
                var dateRange = $('#historyDateRange').val();
                // 实际项目中这里应该根据关键词、状态和日期范围筛选数据
                layer.msg('搜索: ' + keyword + ', 状态: ' + status + ', 时间范围: ' + dateRange, {icon: 1});
            });

            // 全选待确认
            form.on('checkbox(checkAllPending)', function(data) {
                var checked = data.elem.checked;
                $('#pendingTableBody [type="checkbox"]').prop('checked', checked);
                form.render('checkbox');
            });

            // 从需求生成订单
            window.createOrderFromDemand = function(id) {
                var demandData = historyData.find(item => item.id === id);
                if (!demandData || demandData.status !== 'confirmed') {
                    layer.msg('只有已确认的需求才能生成采购订单', {icon: 2});
                    return;
                }
                
                layer.msg(`正在从需求 ${demandData.demandNo} 生成采购订单...`, {icon: 1});
                // 实际项目中这里会跳转到采购订单页面并携带需求数据
            };

            // 编辑需求
            window.editDemand = function(id) {
                var demandData = pendingData.find(item => item.id === id);
                if (!demandData) return;
                
                // 在实际应用中，这里会加载需求数据到表单中进行编辑
                layer.msg('加载需求进行编辑', {icon: 1});
                element.tabChange('demandTab', 'generate');
                
                // 填充表单数据
                $('#demandNo').val(demandData.demandNo);
                $('input[name="demandDate"]').val(demandData.demandDate);
                $('#warehouseSelect').val(demandData.warehouseId);
                $('#strategySelect').val(demandData.strategyId);
                $('select[name="demandCycle"]').val(demandData.demandCycle);
                $('textarea[name="demandRemarks"]').val(demandData.remarks);
                
                // 如果是自定义周期，显示并填充日期
                if (demandData.demandCycle === 'custom') {
                    $('#customCycleContainer').show();
                    // 这里简化处理，实际项目中应该有具体的开始和结束日期
                }
                
                form.render();
            };

            // 标签切换事件
            element.on('tab(demandTab)', function(data) {
                var layId = $(this).attr('lay-id');
                if (layId === 'pending' && $('#pendingTableBody tr').length === 0) {
                    renderPendingList();
                } else if (layId === 'history' && $('#historyTableBody tr').length === 0) {
                    renderHistoryList();
                } else if (layId === 'settings' && $('#strategyList').html() === '') {
                    renderStrategyList();
                }
            });

            // 初始化表单渲染
            form.render();
        });
    </script>
</body>
</html>
    